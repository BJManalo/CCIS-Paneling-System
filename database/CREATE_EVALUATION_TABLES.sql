-- Drop existing tables if they exist to start fresh
DROP TABLE IF EXISTS individual_evaluations;
DROP TABLE IF EXISTS system_evaluations;

-- 1. Create table for System Project Evaluations (Group-based)
CREATE TABLE system_evaluations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    schedule_id BIGINT REFERENCES schedules(id) ON DELETE CASCADE,
    group_id BIGINT REFERENCES student_groups(id) ON DELETE CASCADE,
    panelist_name TEXT NOT NULL,
    
    -- Scores (1-4)
    func_score INTEGER DEFAULT 0,
    tech_score INTEGER DEFAULT 0,
    usability_score INTEGER DEFAULT 0,
    code_score INTEGER DEFAULT 0,
    innov_score INTEGER DEFAULT 0,
    testing_score INTEGER DEFAULT 0,
    docu_score INTEGER DEFAULT 0,
    demo_score INTEGER DEFAULT 0,
    
    total_score INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT now(),

    -- Ensure a panelist only evaluates a specific schedule once
    UNIQUE(schedule_id, panelist_name)
);

-- 2. Create table for Individual Evaluations (Student-based)
CREATE TABLE individual_evaluations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    schedule_id BIGINT REFERENCES schedules(id) ON DELETE CASCADE,
    student_id BIGINT REFERENCES students(id) ON DELETE CASCADE,
    panelist_name TEXT NOT NULL,
    
    -- Scores (1-4)
    clarity_score INTEGER DEFAULT 0,
    engagement_score INTEGER DEFAULT 0,
    delivery_score INTEGER DEFAULT 0,
    knowledge_score INTEGER DEFAULT 0,
    collab_score INTEGER DEFAULT 0,
    prof_score INTEGER DEFAULT 0,
    time_score INTEGER DEFAULT 0,
    
    total_score INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT now(),

    -- Ensure a panelist only evaluates a specific student for a specific schedule once
    UNIQUE(schedule_id, student_id, panelist_name)
);

-- Enable Row Level Security (RLS)
ALTER TABLE system_evaluations ENABLE ROW LEVEL SECURITY;
ALTER TABLE individual_evaluations ENABLE ROW LEVEL SECURITY;

-- Create policies to allow public access (adjust if you have specific auth requirements later)
CREATE POLICY "Allow public access" ON system_evaluations FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow public access" ON individual_evaluations FOR ALL USING (true) WITH CHECK (true);
