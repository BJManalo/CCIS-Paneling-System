<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer - CCIS Paneling System</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #fdfdfd;
        }

        #pdf-view {
            width: 100%;
            height: 100%;
        }

        /* Loading Spinner */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8fafc;
            z-index: 1000;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            color: #1e293b;
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-weight: 600; font-size: 1.1rem;">Initialing Document...</div>
        <div id="status-text" style="font-size: 0.9rem; color: #64748b;">Connecting to secure storage...</div>
    </div>

    <div id="pdf-view"></div>

    <script src="https://documentcloud.adobe.com/view-sdk/viewer.js"></script>
    <script>
        // CLIENT ID
        const ADOBE_CLIENT_ID = "b965033ee6674833ba55cf84132cb88a";

        // Parse Query Params
        const params = new URLSearchParams(window.location.search);
        const fileUrl = params.get('url');
        const fileName = params.get('name') || "Document.pdf";
        const userName = params.get('user') || "Panelist";

        function showStatus(msg, isError = false) {
            console.log("PDF Status:", msg);
            if (isError) {
                const loader = document.getElementById('loader');
                loader.innerHTML = `<div style="color:#ef4444; font-weight:bold; max-width:500px; padding: 20px; line-height:1.6;">${msg}</div>`;
            } else {
                const statusText = document.getElementById('status-text');
                if (statusText) statusText.innerHTML = msg;
            }
        }

        // Timeout to detect hang
        const loadingTimeout = setTimeout(() => {
            if (document.getElementById('loader').style.display !== 'none') {
                showStatus(`The document is taking a while to load from Google Drive. <br><small style="color:#888;">URL: ${fileUrl}</small>`, false);
            }
        }, 10000);

        async function startAdobeViewer() {
            if (!fileUrl) {
                showStatus("Error: No file URL provided.", true);
                return;
            }

            showStatus("Step 1 of 2: Securing connection to Google Drive...");

            const tryFetch = async (targetUrl) => {
                try {
                    const response = await fetch(targetUrl);
                    if (!response.ok) return null;
                    const buffer = await response.arrayBuffer();

                    const head = String.fromCharCode(...new Uint8Array(buffer.slice(0, 4)));
                    if (head === "%PDF") return buffer;

                    // Detect Google's virus scan/confirmation page
                    const text = new TextDecoder().decode(buffer);
                    if (text.includes("confirm=")) {
                        console.log("Detected virus scan confirmation page. Retrying with confirm flag...");
                        const confirmMatch = text.match(/confirm=([a-zA-Z0-9_-]+)/);
                        const confirmCode = confirmMatch ? confirmMatch[1] : 't';
                        const retryUrl = targetUrl + (targetUrl.includes('?') ? '&' : '?') + 'confirm=' + confirmCode;
                        const retryResponse = await fetch(retryUrl);
                        if (retryResponse.ok) {
                            const retryBuffer = await retryResponse.arrayBuffer();
                            if (String.fromCharCode(...new Uint8Array(retryBuffer.slice(0, 4))) === "%PDF") return retryBuffer;
                        }
                    }
                    return null;
                } catch (e) { return null; }
            };

            let arrayBuffer = null;

            // Access strategies: direct, with t-confirm, and via proxy
            const strategies = [
                fileUrl,
                fileUrl + (fileUrl.includes('?') ? '&' : '?') + "confirm=t",
                `https://api.allorigins.win/raw?url=${encodeURIComponent(fileUrl + (fileUrl.includes('?') ? '&' : '?') + "confirm=t")}`
            ];

            for (let i = 0; i < strategies.length; i++) {
                const names = ["Direct Route", "Deep Access", "Bypass Bridge"];
                showStatus(`Attempting ${names[i]}...`);
                arrayBuffer = await tryFetch(strategies[i]);
                if (arrayBuffer) break;
            }

            if (!arrayBuffer) {
                showStatus("System could not retrieve the PDF. This usually happens if the Google Drive file is not set to 'Public'. Please check 'Link Sharing' and ensure it is 'Anyone with the link'.", true);
                return;
            }

            showStatus("Step 2 of 2: Initializing Annotation Tools...");

            try {
                const adobeDCView = new AdobeDC.View({
                    clientId: ADOBE_CLIENT_ID,
                    divId: "pdf-view"
                });

                const fileId = fileUrl.match(/id=([\w-]+)/)?.[1] || "doc_" + Date.now();

                adobeDCView.previewFile({
                    content: { promise: Promise.resolve(arrayBuffer) },
                    metaData: {
                        fileName: fileName,
                        id: fileId
                    }
                }, {
                    embedMode: "FULL_WINDOW",
                    showAnnotationTools: true,
                    enableAnnotationAPIs: true,
                    includePDFAnnotations: true,
                    showLeftHandPanel: true,
                    showDownloadPDF: true,
                    showPrintPDF: true,
                    dockPageControls: false
                }).then(adobeViewer => {
                    clearTimeout(loadingTimeout);
                    document.getElementById('loader').style.display = 'none';

                    adobeViewer.getAnnotationManager().then(annotationManager => {
                        const profileConfig = {
                            userProfile: {
                                name: userName,
                                firstName: userName.split(' ')[0],
                                lastName: userName.split(' ').slice(1).join(' ') || ""
                            }
                        };
                        if (annotationManager.setConfig) annotationManager.setConfig(profileConfig);
                    });
                });
            } catch (err) {
                showStatus(`Adobe SDK Error: ${err.message}`, true);
            }
        }

        // Handle Script Loading
        if (window.AdobeDC) {
            startAdobeViewer();
        } else {
            document.addEventListener("adobe_dc_view_sdk.ready", startAdobeViewer);
        }
    </script>
</body>

</html>